name: Deploy to EC2

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies and update lock file
      run: |
        npm install
        npm install --package-lock-only
      
    - name: Build Docker image
      run: |
        # First clean install to ensure everything is in sync
        npm ci
        # Then build the Docker image
        docker build -t justice-core-backend:${{ github.sha }} .
        
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "Starting deployment to EC2..."
          
          # Install Nginx if not already installed
          if ! command -v nginx &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y nginx
          fi
          
          # Navigate to project directory (clone if first time)
          cd /home/ec2-user/justice-core-backend || (git clone https://github.com/ALLINONETECH/justice-core-backend.git /home/ec2-user/justice-core-backend && cd /home/ec2-user/justice-core-backend)
          
          # Pull latest code from master branch
          git pull origin master
          
          # Ensure .env file exists (copy from backup if needed)
          if [ -f .env.backup ]; then
            cp .env.backup .env
          fi
          
          # Stop existing container
          docker-compose down || true
          
          # Build and start new container
          docker-compose up --build -d
          
          # Clean up old images
          docker system prune -f
          
          # Copy Nginx configuration
          sudo cp ./nginx/justice-core.conf /etc/nginx/sites-available/justice-core

          # Enable the site and remove default if it exists
          sudo rm -f /etc/nginx/sites-enabled/default
          sudo ln -sf /etc/nginx/sites-available/justice-core /etc/nginx/sites-enabled/

          # Test Nginx configuration
          sudo nginx -t
          
          # Restart Nginx
          sudo systemctl restart nginx

          # Wait for application to start
          echo "Waiting for application to start..."
          sleep 15
          
          # Health check with retry (using both localhost and public IP)
          echo "Running health check on localhost..."
          curl -f http://localhost:3006/health || (echo "Health check failed, retrying..." && sleep 10 && curl -f http://localhost:3006/health)
          
          echo "Running health check on public IP..."
          curl -f http://43.205.94.149/health || (echo "Public health check failed, retrying..." && sleep 10 && curl -f http://43.205.94.149/health) || exit 1
          
          # Verify Nginx status and show logs
          echo "Checking Nginx status..."
          sudo systemctl status nginx
          
          echo "Checking listening ports..."
          sudo netstat -tlpn | grep -E ':80|:3006'
          
          echo "Checking Nginx error log..."
          sudo tail -n 50 /var/log/nginx/error.log
          
          echo "Deployment completed successfully!"
          echo "Application is live at: http://43.205.94.149"