name: Deploy to EC2

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies and update lock file
      run: |
        npm install
        npm install --package-lock-only
      
    - name: Build Docker image
      run: |
        # First clean install to ensure everything is in sync
        npm ci
        # Then build the Docker image
        docker build -t justice-core-backend:${{ github.sha }} .
        
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "Starting deployment to EC2..."
          
          # Install required packages
          if ! command -v nginx &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y nginx
          fi

          # Install dos2unix for line ending fixes
          if ! command -v dos2unix &> /dev/null; then
            sudo apt-get install -y dos2unix
          fi

          # Create Nginx directories if they don't exist
          sudo mkdir -p /etc/nginx/sites-available /etc/nginx/sites-enabled
          
          # Navigate to project directory (clone if first time)
          cd /home/ubuntu/justice-core-backend || (git clone https://github.com/ALLINONETECH/justice-core-backend.git /home/ubuntu/justice-core-backend && cd /home/ubuntu/justice-core-backend)
          
          # Reset any local changes and pull latest code
          git reset --hard
          git clean -fd
          git pull origin master
          
          # Ensure .env file exists (copy from backup if needed)
          if [ -f .env.backup ]; then
            cp .env.backup .env
          fi
          
          # Stop existing container
          docker-compose down || true
          
          # Build and start new container
          docker-compose up --build -d
          
          # Clean up old images
          docker system prune -f
          
          # Copy and fix Nginx configuration
          sudo cp ./nginx/justice-core.conf /etc/nginx/sites-available/justice-core
          sudo dos2unix /etc/nginx/sites-available/justice-core

          # Enable the site and remove default if it exists
          sudo rm -f /etc/nginx/sites-enabled/default
          sudo ln -sf /etc/nginx/sites-available/justice-core /etc/nginx/sites-enabled/

          # Test Nginx configuration and show any errors
          sudo nginx -t
          
          # Make sure nginx user has proper permissions
          sudo chown -R www-data:www-data /etc/nginx/sites-available/justice-core
          
          # Restart Nginx
          sudo systemctl restart nginx

          # Wait for application to start
          echo "Waiting for application to start..."
          sleep 15
          
          # Health check with retry and debugging
          echo "Running direct health check..."
          curl -v http://localhost:3006/health || (echo "Direct health check failed, retrying..." && sleep 10 && curl -v http://localhost:3006/health)
          
          echo "Verifying Nginx configuration..."
          sudo nginx -t
          sudo systemctl status nginx
          
          echo "Running Nginx health check..."
          curl -v http://localhost/health || (
            echo "Nginx health check failed. Debugging info:"
            echo "Nginx error log:"
            sudo tail -n 50 /var/log/nginx/error.log
            echo "Nginx access log:"
            sudo tail -n 50 /var/log/nginx/access.log
            echo "Retrying health check..."
            sleep 10 
            curl -v http://localhost/health
          )
          
          echo "Running public health check..."
          curl -v http://${{ secrets.EC2_HOST }}/health || (
            echo "Public health check failed. Debugging info:"
            echo "Network status:"
            sudo ss -tlnp | grep -E ':80|:3006'
            echo "Nginx config:"
            cat /etc/nginx/sites-available/justice-core
            echo "Retrying health check..."
            sleep 10
            curl -v http://${{ secrets.EC2_HOST }}/health
          ) || exit 1
          
          # Verify Nginx status and show logs
          echo "Checking Nginx status..."
          sudo systemctl status nginx
          
          echo "Checking listening ports..."
          sudo netstat -tlpn | grep -E ':80|:3006'
          
          echo "Checking Nginx error log..."
          sudo tail -n 50 /var/log/nginx/error.log
          
          echo "Deployment completed successfully!"
          echo "Application is live at: http://${{ secrets.EC2_HOST }}"
